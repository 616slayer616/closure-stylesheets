<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreateStandardAtRuleNodes.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">closure-stylesheets</a> &gt; <a href="index.source.html" class="el_package">com.google.common.css.compiler.passes</a> &gt; <span class="el_source">CreateStandardAtRuleNodes.java</span></div><h1>CreateStandardAtRuleNodes.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2009 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.google.common.css.compiler.passes;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Lists;
import com.google.common.css.compiler.ast.*;
import com.google.common.css.compiler.ast.CssAtRuleNode.Type;

import java.util.List;

/**
 * A compiler pass that transforms standard {@link CssUnknownAtRuleNode} instances to more specific
 * at-rule nodes, or deletes them.
 */
public class CreateStandardAtRuleNodes implements UniformVisitor, CssCompilerPass {

    @VisibleForTesting
    static final String NO_BLOCK_ERROR_MESSAGE = &quot;This @-rule has to have a block&quot;;

    @VisibleForTesting
    static final String BLOCK_ERROR_MESSAGE = &quot;This @-rule is not allowed to have a block&quot;;

    @VisibleForTesting
    static final String ONLY_DECLARATION_BLOCK_ERROR_MESSAGE =
            &quot;Only declaration blocks are allowed for this @-rule&quot;;

    @VisibleForTesting
    static final String INVALID_PARAMETERS_ERROR_MESSAGE = &quot;This @-rule has invalid parameters&quot;;

    @VisibleForTesting
    static final String MEDIA_INVALID_CHILD_ERROR_MESSAGE =
            &quot;This is not valid inside an @media block&quot;;

    @VisibleForTesting
    static final String MEDIA_WITHOUT_PARAMETERS_ERROR_MESSAGE = &quot;@media without parameters&quot;;

    @VisibleForTesting
    static final String PAGE_SELECTOR_PARAMETERS_ERROR_MESSAGE =
            &quot;Page selectors are not allowed to have parameters&quot;;

    @VisibleForTesting
    static final String FONT_FACE_PARAMETERS_ERROR_MESSAGE =
            &quot;@font-face is not allowed to have parameters&quot;;

    @VisibleForTesting
    static final String IGNORED_IMPORT_WARNING_MESSAGE =
            &quot;@import rules should occur outside blocks and can only be preceded &quot;
                    + &quot;by @charset and other @import rules.&quot;;

    @VisibleForTesting
    static final String IGNORE_IMPORT_WARNING_MESSAGE =
            &quot;A node after which all @import rule nodes are ignored is here.&quot;;

<span class="fc" id="L71">    private static final ImmutableList&lt;Type&gt; PAGE_SELECTORS =</span>
<span class="fc" id="L72">            ImmutableList.of(</span>
                    Type.TOP_LEFT_CORNER,
                    Type.TOP_LEFT,
                    Type.TOP_CENTER,
                    Type.TOP_RIGHT,
                    Type.TOP_RIGHT_CORNER,
                    Type.LEFT_TOP,
                    Type.LEFT_MIDDLE,
                    Type.LEFT_BOTTOM,
                    Type.RIGHT_TOP,
                    Type.RIGHT_MIDDLE,
                    Type.RIGHT_BOTTOM,
                    Type.BOTTOM_LEFT_CORNER,
                    Type.BOTTOM_LEFT,
                    Type.BOTTOM_CENTER,
                    Type.BOTTOM_RIGHT,
                    Type.BOTTOM_RIGHT_CORNER);
<span class="fc" id="L89">    private static final ImmutableSet&lt;String&gt; PSEUDO_PAGES =</span>
<span class="fc" id="L90">            ImmutableSet.of(&quot;:left&quot;, &quot;:right&quot;, &quot;:first&quot;);</span>
    // Not all @-rules make sense inside an @media block. For
    // example: @charset, @import, @namespace are only permitted at the
    // beginning of a stylesheet. Also, @def should never be allowed
    // because it can be misleading; @def rules are processed by the
    // compiler but @media rules are handled by the browser.
<span class="fc" id="L96">    private static final ImmutableSet&lt;String&gt; ALLOWED_AT_RULES_IN_MEDIA = ImmutableSet.of(</span>
            &quot;page&quot;, &quot;if&quot;, &quot;elseif&quot;, &quot;else&quot;, &quot;for&quot;, &quot;media&quot;, &quot;keyframes&quot;, &quot;supports&quot;, &quot;font-face&quot;);

    private final MutatingVisitController visitController;
    private final ErrorManager errorManager;
<span class="fc" id="L101">    private final List&lt;CssImportRuleNode&gt; nonIgnoredImportRules =</span>
<span class="fc" id="L102">            Lists.newArrayList();</span>
    private CssRootNode root;

    /**
     * The first node after which import rules will be ignored, or null if
     * no such nodes have been discovered.
     */
    private CssNode noMoreImportRules;

    public CreateStandardAtRuleNodes(
<span class="fc" id="L112">            MutatingVisitController visitController, ErrorManager errorManager) {</span>
<span class="fc" id="L113">        this.visitController = visitController;</span>
<span class="fc" id="L114">        this.errorManager = errorManager;</span>
<span class="fc" id="L115">    }</span>

    private void enterTree(CssRootNode root) {
<span class="fc" id="L118">        this.root = root;</span>
<span class="fc" id="L119">        noMoreImportRules = null;</span>
<span class="fc" id="L120">    }</span>

    @Override
    public void leave(CssNode node) {
<span class="pc bpc" id="L124" title="1 of 4 branches missed.">        if (!(node instanceof CssImportRuleNode)</span>
                &amp;&amp; !(node instanceof CssImportBlockNode)
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                &amp;&amp; node != root.getCharsetRule()) {</span>
<span class="fc" id="L127">            noMoreImportRules = node;</span>
        }
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (node instanceof CssRootNode) {</span>
<span class="fc" id="L130">            leaveTree((CssRootNode) node);</span>
        }
<span class="fc" id="L132">    }</span>

    @Override
    public void enter(CssNode cssNode) {
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (cssNode instanceof CssRootNode) {</span>
<span class="fc" id="L137">            enterTree((CssRootNode) cssNode);</span>
        }
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (!(cssNode instanceof CssUnknownAtRuleNode)) {</span>
<span class="fc" id="L140">            return;</span>
        }
<span class="fc" id="L142">        CssUnknownAtRuleNode node = (CssUnknownAtRuleNode) cssNode;</span>
<span class="fc" id="L143">        String charsetName = CssAtRuleNode.Type.CHARSET.getCanonicalName();</span>
<span class="fc" id="L144">        String importName = CssAtRuleNode.Type.IMPORT.getCanonicalName();</span>
<span class="fc" id="L145">        String mediaName = CssAtRuleNode.Type.MEDIA.getCanonicalName();</span>
<span class="fc" id="L146">        String pageName = CssAtRuleNode.Type.PAGE.getCanonicalName();</span>
<span class="fc" id="L147">        String fontFaceName = CssAtRuleNode.Type.FONT_FACE.getCanonicalName();</span>

<span class="fc" id="L149">        List&lt;CssValueNode&gt; params = node.getParameters();</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">        if (node.getName().getValue().equals(charsetName)) {</span>
<span class="fc" id="L152">            createCharsetRule(node);</span>
<span class="fc" id="L153">            return;</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">        } else if (node.getName().getValue().equals(importName)) {</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if (params.isEmpty()) {</span>
<span class="fc" id="L156">                reportError(&quot;@&quot; + importName + &quot; without a following string or uri&quot;, node);</span>
<span class="fc" id="L157">                return;</span>
            }
<span class="fc bfc" id="L159" title="All 2 branches covered.">            if (params.size() &gt; 2) {</span>
<span class="fc" id="L160">                reportError(&quot;@&quot; + importName + &quot; with too many parameters&quot;, node);</span>
<span class="fc" id="L161">                return;</span>
            }
<span class="fc" id="L163">            CssValueNode param = params.get(0);</span>
<span class="fc bfc" id="L164" title="All 4 branches covered.">            if (!((param instanceof CssStringNode) || checkIfUri(param))) {</span>
<span class="fc" id="L165">                reportError(&quot;@&quot; + importName + &quot;'s first parameter has to be a string or an url&quot;, node);</span>
<span class="fc" id="L166">                return;</span>
            }
<span class="fc" id="L168">            List&lt;CssValueNode&gt; paramlist = Lists.newArrayList(param);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">            if (params.size() == 2) {</span>
<span class="fc" id="L170">                CssValueNode param2 = params.get(1);</span>
<span class="pc bpc" id="L171" title="3 of 4 branches missed.">                if (param2 instanceof CssCompositeValueNode || param2 instanceof CssLiteralNode) {</span>
<span class="fc" id="L172">                    paramlist.add(param2);</span>
                } else {
<span class="nc" id="L174">                    reportError(&quot;@&quot; + importName + &quot; has illegal parameter&quot;, node);</span>
<span class="nc" id="L175">                    return;</span>
                }
            }
<span class="fc" id="L178">            CssImportRuleNode importRule = new CssImportRuleNode(node.getComments());</span>
<span class="fc" id="L179">            importRule.setParameters(paramlist);</span>
<span class="fc" id="L180">            importRule.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (noMoreImportRules != null) {</span>
<span class="fc" id="L182">                visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L183">                        Lists.newArrayList((CssNode) importRule),</span>
                        false /* visitTheReplacementNodes */);
<span class="fc" id="L185">                reportWarning(IGNORED_IMPORT_WARNING_MESSAGE, node);</span>
<span class="fc" id="L186">                reportWarning(IGNORE_IMPORT_WARNING_MESSAGE, noMoreImportRules);</span>
            } else {
<span class="fc" id="L188">                visitController.removeCurrentNode();</span>
<span class="fc" id="L189">                nonIgnoredImportRules.add(importRule);</span>
            }
<span class="fc" id="L191">            return;</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">        } else if (node.getName().getValue().equals(mediaName)) {</span>
<span class="fc" id="L193">            createMediaRule(node);</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">        } else if (node.getName().getValue().equals(pageName)) {</span>
<span class="fc" id="L195">            createPageRule(node);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        } else if (node.getName().getValue().equals(fontFaceName)) {</span>
<span class="fc" id="L197">            createFontFaceRule(node);</span>
        } else {
<span class="fc bfc" id="L199" title="All 2 branches covered.">            for (Type type : PAGE_SELECTORS) {</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">                if (node.getName().getValue().equals(type.getCanonicalName())) {</span>
<span class="fc" id="L201">                    createPageSelector(type, node);</span>
<span class="fc" id="L202">                    break;</span>
                }
<span class="fc" id="L204">            }</span>
        }
<span class="fc" id="L206">    }</span>

    private void leaveTree(CssRootNode root) {
<span class="fc bfc" id="L209" title="All 2 branches covered.">        for (CssImportRuleNode importRule : nonIgnoredImportRules) {</span>
<span class="fc" id="L210">            root.getImportRules().addChildToBack(importRule);</span>
<span class="fc" id="L211">        }</span>
<span class="fc" id="L212">    }</span>

    /**
     * See the
     * &lt;a href=&quot;http://www.w3.org/TR/CSS21/grammar.html#grammar&quot;&gt;CSS 2.1 syntax
     * &lt;/a&gt;, and
     * &lt;a href=&quot;http://www.w3.org/TR/css3-mediaqueries/#syntax&quot;&gt;CSS 3 syntax&lt;/a&gt;
     * for more information.
     */
    private void createMediaRule(CssUnknownAtRuleNode node) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (node.getBlock() == null) {</span>
<span class="fc" id="L223">            reportError(NO_BLOCK_ERROR_MESSAGE, node);</span>
<span class="fc" id="L224">            return;</span>
        }

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (!(node.getBlock() instanceof CssBlockNode)) {</span>
<span class="nc" id="L228">            reportError(ONLY_DECLARATION_BLOCK_ERROR_MESSAGE, node);</span>
<span class="nc" id="L229">            return;</span>
        }

<span class="fc" id="L232">        CssBlockNode block = (CssBlockNode) node.getBlock();</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">        for (CssNode part : block.childIterable()) {</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">            if (!isValidInMediaRule(part)) {</span>
<span class="fc" id="L235">                reportError(MEDIA_INVALID_CHILD_ERROR_MESSAGE, part);</span>
<span class="fc" id="L236">                return;</span>
            }
<span class="fc" id="L238">        }</span>

<span class="fc" id="L240">        List&lt;CssValueNode&gt; params = node.getParameters();</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (params.isEmpty()) {</span>
<span class="fc" id="L242">            reportError(MEDIA_WITHOUT_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L243">            return;</span>
        }

        // TODO(fbenz): Perform this check depending on the CSS version set in the
        // options
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (!checkMediaParameter(params)) {</span>
<span class="fc" id="L249">            reportError(INVALID_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L250">            return;</span>
        }
<span class="fc" id="L252">        CssMediaRuleNode mediaRule = new CssMediaRuleNode(node.getComments(),</span>
                block);
<span class="fc" id="L254">        mediaRule.setParameters(params);</span>
<span class="fc" id="L255">        mediaRule.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc" id="L256">        visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L257">                Lists.newArrayList(mediaRule), true /* visitTheReplacementNodes */);</span>
<span class="fc" id="L258">    }</span>

    /**
     * Checks whether the parameters of a @media rule match the grammar of the
     * CSS 3 draft.
     */
    private boolean checkMediaParameter(List&lt;CssValueNode&gt; params) {
<span class="fc bfc" id="L265" title="All 2 branches covered.">        if (params.get(0) instanceof CssCompositeValueNode) {</span>
<span class="fc" id="L266">            return checkMediaCompositeExpression(params, 0);</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">        } else if (params.get(0) instanceof CssBooleanExpressionNode) {</span>
            // shorthand syntax: implicit &quot;all and...&quot;
<span class="fc" id="L269">            return checkMediaExpression(params, 0);</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        } else if (!(params.get(0) instanceof CssLiteralNode)) {</span>
            // nodes like the function node are invalid
<span class="nc" id="L272">            CssValueNode node = params.get(0);</span>
<span class="nc" id="L273">            reportWarning(</span>
<span class="nc" id="L274">                    String.format(</span>
                            &quot;Expected CssLiteralNode but found %s&quot;,
<span class="nc" id="L276">                            node.getClass().getName()),</span>
                    node);
<span class="nc" id="L278">            return false;</span>
        }
<span class="fc" id="L280">        int numberOfStartingLiterals = 1;</span>
<span class="fc" id="L281">        String firstValue = params.get(0).getValue();</span>
<span class="fc bfc" id="L282" title="All 4 branches covered.">        if (firstValue.equals(&quot;only&quot;) || firstValue.equals(&quot;not&quot;)) {</span>
<span class="fc" id="L283">            numberOfStartingLiterals = 2;</span>
        }
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (params.size() &lt; numberOfStartingLiterals) {</span>
            // only 'only' or 'not'
<span class="nc" id="L287">            reportWarning(</span>
                    &quot;Expected CssLiteralNode after 'only' or 'not'.&quot;,
<span class="nc" id="L289">                    params.get(params.size() - 1));</span>
<span class="nc" id="L290">            return false;</span>
        }
<span class="fc bfc" id="L292" title="All 2 branches covered.">        if (params.size() - numberOfStartingLiterals &gt; 0) {</span>
<span class="fc" id="L293">            return checkAndMediaExpression(params, numberOfStartingLiterals);</span>
        }
<span class="fc" id="L295">        return true;</span>
    }

    /**
     * Checks for [ AND S* expression ]* where expression is some value.
     */
    private boolean checkAndMediaExpression(
            List&lt;CssValueNode&gt; params, int start) {
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (params.size() - start &lt; 2) {</span>
            // at least two more: 'and X'
<span class="fc" id="L305">            return false;</span>
        }
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (!params.get(start).getValue().equals(&quot;and&quot;)) {</span>
            // expected 'and'
<span class="fc" id="L309">            return false;</span>
        }
<span class="fc" id="L311">        return checkMediaExpression(params, start + 1);</span>
    }

    /**
     * Checks for S* expression | S* expression [ AND S* expression ]*
     * where expression is some value.
     */
    private boolean checkMediaExpression(
            List&lt;CssValueNode&gt; params, int start) {
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (params.size() - start &lt; 1) {</span>
            // at least one
<span class="nc" id="L322">            return false;</span>
        }
<span class="fc bfc" id="L324" title="All 2 branches covered.">        if (params.get(start) instanceof CssCompositeValueNode) {</span>
<span class="fc" id="L325">            return checkMediaCompositeExpression(params, start);</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">        } else if (params.size() &gt; start + 1) {</span>
<span class="fc" id="L327">            return checkAndMediaExpression(params, start + 1);</span>
        }
<span class="fc" id="L329">        return true;</span>
    }

    /**
     * Splits up a composite value so that it can be checked. Two values with
     * a comma in between are combined to a composite value.
     * For example:
     * {@code screen and (device-width:800px), print}
     * turns into this list of values:
     * {@code screen}, {@code and}, {@code (device-width:800px), print}
     * where the last value is a composite value that consists of two values.
     */
    private boolean checkMediaCompositeExpression(List&lt;CssValueNode&gt; params,
                                                  int start) {
<span class="fc" id="L343">        CssCompositeValueNode comp = (CssCompositeValueNode) params.get(start);</span>
        CssValueNode startValue;
<span class="fc bfc" id="L345" title="All 2 branches covered.">        if (comp.getValues().size() == 2) {</span>
<span class="fc" id="L346">            startValue = comp.getValues().get(1);</span>
        } else {
<span class="fc" id="L348">            List&lt;CssValueNode&gt; newChildren = Lists.newArrayList(comp.getValues());</span>
<span class="fc" id="L349">            newChildren.remove(0);</span>
<span class="fc" id="L350">            startValue = new CssCompositeValueNode(newChildren,</span>
<span class="fc" id="L351">                    comp.getOperator(), comp.getSourceCodeLocation());</span>
        }
<span class="fc" id="L353">        List&lt;CssValueNode&gt; newParams = Lists.newArrayList(startValue);</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">        for (int i = 0; i &lt; params.size(); i++) {</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">            if (i &gt; start) {</span>
<span class="fc" id="L356">                newParams.add(params.get(i));</span>
            }
        }
<span class="fc" id="L359">        return checkMediaParameter(newParams);</span>
    }

    private boolean isValidInMediaRule(CssNode node) {
<span class="fc bfc" id="L363" title="All 2 branches covered.">        if (node instanceof CssRulesetNode) {</span>
            // rulesets like .CLASS { ... }
<span class="fc" id="L365">            return true;</span>
        }
<span class="fc bfc" id="L367" title="All 4 branches covered.">        if (node instanceof CssAtRuleNode &amp;&amp; ALLOWED_AT_RULES_IN_MEDIA.contains(</span>
<span class="fc" id="L368">                ((CssAtRuleNode) node).getName().getValue())) {</span>
            // like @page or @if, but not @def
<span class="fc" id="L370">            return true;</span>
        }
<span class="fc bfc" id="L372" title="All 2 branches covered.">        if (node instanceof CssConditionalBlockNode) {</span>
            // @if, @elseif, @else after processing because then they are not @-rules
            // anymore
<span class="fc" id="L375">            return true;</span>
        }
<span class="fc" id="L377">        return false;</span>
    }

    /**
     * See the
     * &lt;a href=&quot;http://www.w3.org/TR/css3-page/#syntax-page-selector&quot;&gt;
     * Page selector grammar&lt;/a&gt; for more information.
     */
    private void createPageRule(CssUnknownAtRuleNode node) {
<span class="fc bfc" id="L386" title="All 2 branches covered.">        if (node.getBlock() == null) {</span>
<span class="fc" id="L387">            reportError(NO_BLOCK_ERROR_MESSAGE, node);</span>
<span class="fc" id="L388">            return;</span>
        }
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">        if (!(node.getBlock() instanceof CssDeclarationBlockNode)) {</span>
<span class="nc" id="L391">            reportError(ONLY_DECLARATION_BLOCK_ERROR_MESSAGE, node);</span>
<span class="nc" id="L392">            return;</span>
        }
<span class="fc" id="L394">        List&lt;CssValueNode&gt; params = node.getParameters();</span>
<span class="fc" id="L395">        int numParams = params.size();</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        if (numParams &gt; 2) {</span>
<span class="fc" id="L397">            reportError(INVALID_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L398">            return;</span>
<span class="fc bfc" id="L399" title="All 4 branches covered.">        } else if (numParams == 2 &amp;&amp; !PSEUDO_PAGES.contains(params.get(1).getValue())) {</span>
<span class="fc" id="L400">            reportError(INVALID_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L401">            return;</span>
<span class="fc bfc" id="L402" title="All 2 branches covered.">        } else if (numParams == 1) {</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">            if (params.get(0).getValue().startsWith(&quot;:&quot;)</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">                    &amp;&amp; !PSEUDO_PAGES.contains(params.get(0).getValue())) {</span>
<span class="fc" id="L405">                reportError(INVALID_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L406">                return;</span>
            }
        }
<span class="fc" id="L409">        CssDeclarationBlockNode block = (CssDeclarationBlockNode) node.getBlock();</span>
<span class="fc" id="L410">        CssPageRuleNode pageRule = new CssPageRuleNode(node.getComments(),</span>
                block);
<span class="fc" id="L412">        pageRule.setParameters(params);</span>
<span class="fc" id="L413">        pageRule.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc" id="L414">        visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L415">                Lists.newArrayList(pageRule), true /* visitTheReplacementNodes */);</span>
<span class="fc" id="L416">    }</span>

    private void createPageSelector(Type type, CssUnknownAtRuleNode node) {
<span class="fc bfc" id="L419" title="All 2 branches covered.">        if (node.getBlock() == null) {</span>
<span class="fc" id="L420">            reportError(NO_BLOCK_ERROR_MESSAGE, node);</span>
<span class="fc" id="L421">            return;</span>
        }
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">        if (!(node.getBlock() instanceof CssDeclarationBlockNode)) {</span>
<span class="nc" id="L424">            reportError(ONLY_DECLARATION_BLOCK_ERROR_MESSAGE, node);</span>
<span class="nc" id="L425">            return;</span>
        }
<span class="fc bfc" id="L427" title="All 2 branches covered.">        if (!node.getParameters().isEmpty()) {</span>
<span class="fc" id="L428">            reportError(PAGE_SELECTOR_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L429">            return;</span>
        }
<span class="fc" id="L431">        CssDeclarationBlockNode block = (CssDeclarationBlockNode) node.getBlock();</span>
<span class="fc" id="L432">        CssPageSelectorNode pageSelector = new CssPageSelectorNode(type,</span>
<span class="fc" id="L433">                node.getComments(), block);</span>
<span class="fc" id="L434">        pageSelector.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc" id="L435">        visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L436">                Lists.newArrayList(pageSelector), true /* visitTheReplacementNodes */);</span>
<span class="fc" id="L437">    }</span>

    private void createCharsetRule(CssUnknownAtRuleNode node) {
<span class="fc" id="L440">        CssCharSetNode charSet = new CssCharSetNode(node.getComments());</span>
<span class="fc" id="L441">        charSet.setParameters(node.getChildren());</span>
<span class="fc" id="L442">        charSet.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc" id="L443">        visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L444">                Lists.newArrayList(charSet), true /* visitTheReplacementNodes */);</span>
<span class="fc" id="L445">    }</span>

    /**
     * See the
     * &lt;a href=&quot;http://www.w3.org/TR/css3-fonts/#font-face-rule&quot;&gt;
     * font-face grammar&lt;/a&gt; for more information.
     */
    private void createFontFaceRule(CssUnknownAtRuleNode node) {
<span class="fc bfc" id="L453" title="All 2 branches covered.">        if (node.getBlock() == null) {</span>
<span class="fc" id="L454">            reportError(NO_BLOCK_ERROR_MESSAGE, node);</span>
<span class="fc" id="L455">            return;</span>
        }
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">        if (!(node.getBlock() instanceof CssDeclarationBlockNode)) {</span>
<span class="nc" id="L458">            reportError(ONLY_DECLARATION_BLOCK_ERROR_MESSAGE, node);</span>
<span class="nc" id="L459">            return;</span>
        }
<span class="fc bfc" id="L461" title="All 2 branches covered.">        if (!node.getParameters().isEmpty()) {</span>
<span class="fc" id="L462">            reportError(FONT_FACE_PARAMETERS_ERROR_MESSAGE, node);</span>
<span class="fc" id="L463">            return;</span>
        }

        // TODO(bolinfest): Verify that all declarations in the block are valid
        // font-descriptions: font-family, src, font-style, etc. See
        // http://www.w3.org/TR/css3-fonts/#font-resources for a complete list.

<span class="fc" id="L470">        CssDeclarationBlockNode block = (CssDeclarationBlockNode) node.getBlock();</span>
<span class="fc" id="L471">        CssFontFaceNode fontFace = new CssFontFaceNode(node.getComments(), block);</span>
<span class="fc" id="L472">        fontFace.setSourceCodeLocation(node.getSourceCodeLocation());</span>
<span class="fc" id="L473">        visitController.replaceCurrentBlockChildWith(</span>
<span class="fc" id="L474">                Lists.newArrayList(fontFace), true /* visitTheReplacementNodes */);</span>
<span class="fc" id="L475">    }</span>

    private boolean checkIfUri(CssValueNode node) {
<span class="fc bfc" id="L478" title="All 2 branches covered.">        if (!(node instanceof CssFunctionNode)) {</span>
<span class="fc" id="L479">            return false;</span>
        }
<span class="fc" id="L481">        CssFunctionNode function = (CssFunctionNode) node;</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">        if (function.getFunctionName().toLowerCase().equals(&quot;url&quot;)) {</span>
<span class="fc" id="L483">            return true;</span>
        }
<span class="nc" id="L485">        return false;</span>
    }

    private void reportError(String message, CssNode node) {
<span class="fc" id="L489">        errorManager.report(new GssError(message, node.getSourceCodeLocation()));</span>
<span class="fc" id="L490">        visitController.removeCurrentNode();</span>
<span class="fc" id="L491">    }</span>

    private void reportWarning(String message, CssNode node) {
<span class="fc" id="L494">        errorManager.reportWarning(</span>
<span class="fc" id="L495">                new GssError(message, node.getSourceCodeLocation()));</span>
<span class="fc" id="L496">    }</span>

    @Override
    public void runPass() {
<span class="fc" id="L500">        visitController.startVisit(UniformVisitor.Adapters.asVisitor(this));</span>
<span class="fc" id="L501">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>